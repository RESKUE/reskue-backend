<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CulturalAssetService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCo Coverage Report</a> &gt; <a href="index.source.html" class="el_package">reskue.culturalasset</a> &gt; <span class="el_source">CulturalAssetService.java</span></div><h1>CulturalAssetService.java</h1><pre class="source lang-java linenums">package reskue.culturalasset;

import java.lang.reflect.InvocationTargetException;
import java.util.List;
import java.util.function.Predicate;
import java.util.stream.Collectors;

import javax.annotation.PostConstruct;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Root;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;
import org.springframework.data.rest.webmvc.ResourceNotFoundException;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.server.ResponseStatusException;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonMappingException;

import kueres.event.EventType;
import kueres.eventbus.EventConsumer;
import kueres.location.LocationService;
import kueres.query.EntitySpecification;
import kueres.utility.Utility;
import reskue.ReskueService;
import reskue.comment.CommentEntity;
import reskue.notification.NotificationEntity;
import reskue.task.TaskEntity;
import reskue.task.TaskRepository;

/**
 * 
 * The CulturalAssetService provides services needed by the
 * CulturalAssetController.
 *
 * @author Jan Strassburg, jan.strassburg@student.kit.edu
 * @version 1.0
 * @since Feb 25, 2021
 *
 */

@Service
<span class="fc" id="L50">public class CulturalAssetService extends ReskueService&lt;CulturalAssetEntity, CulturalAssetRepository&gt; {</span>

	/**
	 * The LocationService needed to save cultural assets in the FROST server.
	 */
	@Autowired
	protected LocationService locationService;

	/**
	 * The TaskRepository of the TaskEntity needed to save TaskEntitys after
	 * updating them.
	 */
	@Autowired
	protected TaskRepository taskRepository;

	/**
	 * The EntityManager needed to create a CriteriaBuilder.
	 */
	@PersistenceContext
	private EntityManager em;

	/**
	 * Set this EventSubscribers identifier and routing.
	 */
	@Override
	@PostConstruct
	public void init() {
<span class="fc" id="L77">		this.identifier = CulturalAssetController.ROUTE;</span>
<span class="fc" id="L78">		this.routingKey = CulturalAssetController.ROUTE;</span>
<span class="fc" id="L79">	}</span>

	/**
	 * Create a CulturalAssetEntity.
	 * 
	 * @param entity - the cultural asset that should be created. This cultural
	 *               asset can not have an identifier.
	 * @return The created cultural asset. This contains the cultural asset's
	 *         identifier.
	 */
	@Override
	public CulturalAssetEntity create(CulturalAssetEntity entity) {

<span class="fc" id="L92">		Utility.LOG.trace(&quot;CulturalAssetService.create called.&quot;);</span>

<span class="pc bpc" id="L94" title="2 of 4 branches missed.">		if (entity.getLongitude() != null &amp;&amp; entity.getLatitude() != null) {</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">			if (entity.getAddress() == null) {</span>
<span class="nc" id="L96">				entity.setAddress(locationService</span>
<span class="nc" id="L97">						.coordinatesToAddress(new double[] { entity.getLongitude(), entity.getLatitude() }));</span>
			}
<span class="nc bnc" id="L99" title="All 2 branches missed.">		} else if (entity.getAddress() != null) {</span>
<span class="nc bnc" id="L100" title="All 4 branches missed.">			if (entity.getLongitude() == null &amp;&amp; entity.getLatitude() == null) {</span>
<span class="nc" id="L101">				double[] updatedCoordinates = locationService.addressToCoordinates(entity.getAddress());</span>
<span class="nc" id="L102">				entity.setLongitude(updatedCoordinates[0]);</span>
<span class="nc" id="L103">				entity.setLatitude(updatedCoordinates[1]);</span>
			}
		}

<span class="pc bpc" id="L107" title="2 of 4 branches missed.">		if (entity.getLongitude() != null &amp;&amp; entity.getLatitude() != null) {</span>
<span class="fc" id="L108">			entity.setLocationId(locationService.addPOI(entity.getName(),</span>
<span class="fc" id="L109">					new double[] { entity.getLongitude(), entity.getLatitude() }));</span>
		}

<span class="fc" id="L112">		CulturalAssetEntity savedEntity = this.repository.save(entity);</span>

<span class="fc bfc" id="L114" title="All 2 branches covered.">		if (entity.getCulturalAssetParent() != null) {</span>
<span class="fc" id="L115">			CulturalAssetEntity parent = this.findById(entity.getCulturalAssetParent().getId());</span>
<span class="fc" id="L116">			this.addConnection(savedEntity, parent);</span>
<span class="fc" id="L117">			this.repository.save(parent);</span>
			
		}

		// Warum gibt es hier ein oder?
<span class="pc bpc" id="L122" title="3 of 4 branches missed.">		if (entity.getCulturalAssetChildren() != null || !entity.getCulturalAssetChildren().isEmpty()) {</span>
<span class="fc" id="L123">			List&lt;CulturalAssetEntity&gt; children = entity.getCulturalAssetChildren().stream()</span>
<span class="fc" id="L124">					.map((CulturalAssetEntity child) -&gt; {</span>
<span class="fc" id="L125">						return this.findById(child.getId());					</span>
<span class="fc" id="L126">					}).collect(Collectors.toList());			</span>
<span class="fc" id="L127">			children.stream().forEach((CulturalAssetEntity child) -&gt; {				</span>
<span class="fc" id="L128">				this.addConnection(child, savedEntity);</span>
<span class="fc" id="L129">				this.repository.save(child);</span>
<span class="fc" id="L130">			});</span>

		}

<span class="fc" id="L134">		EventConsumer.sendEvent(&quot;CulturalAssetService.create&quot;, EventType.CREATE.type, this.getIdentifier(),</span>
<span class="fc" id="L135">				EventConsumer.writeObjectAsJSON(savedEntity));</span>

<span class="fc" id="L137">		return savedEntity;</span>

	}

	/**
	 * Update a cultural asset. Fields that are not populated in the updated data
	 * will not be changed.
	 * 
	 * @param id      - the cultural asset's identifier.
	 * @param details - the updated data.
	 * @return The updated cultural asset.
	 * @throws ResourceNotFoundException if there is no cultural asset with the
	 *                                   specified identifier.
	 * @throws JsonProcessingException 
	 * @throws SecurityException 
	 * @throws NoSuchMethodException 
	 * @throws InvocationTargetException 
	 * @throws IllegalArgumentException 
	 * @throws IllegalAccessException 
	 * @throws InstantiationException 
	 * @throws JsonMappingException 
	 */
	//@Override
	public CulturalAssetEntity update(long id, String detailsJSON) throws ResourceNotFoundException, JsonMappingException, InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException, NoSuchMethodException, SecurityException, JsonProcessingException {

<span class="fc" id="L162">		Utility.LOG.trace(&quot;CulturalAssetService.update called.&quot;);</span>

<span class="fc" id="L164">		CulturalAssetEntity details = CulturalAssetEntity.createEntityFromJSON(detailsJSON, new CulturalAssetEntity().getUpdateableFields(), CulturalAssetEntity.class);</span>
		
<span class="fc" id="L166">		CulturalAssetEntity entity = this.findById(id);</span>

<span class="fc" id="L168">		entity.applyPatch(detailsJSON);</span>
		
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">		if (entity.getCulturalAssetParent() != null) {</span>
<span class="fc" id="L171">			CulturalAssetEntity parent = this.findById(entity.getCulturalAssetParent().getId());</span>
<span class="fc" id="L172">			this.removeConnection(entity, parent);</span>
<span class="fc" id="L173">			this.repository.save(parent);</span>
		}

<span class="pc bpc" id="L176" title="1 of 2 branches missed.">		if (entity.getCulturalAssetChildren() != null) {</span>
<span class="fc" id="L177">			List&lt;CulturalAssetEntity&gt; children = entity.getCulturalAssetChildren().stream().map((CulturalAssetEntity child) -&gt; {</span>
<span class="fc" id="L178">				return this.findById(child.getId());</span>
<span class="fc" id="L179">			}).collect(Collectors.toList());</span>
<span class="fc" id="L180">			children.stream().forEach((CulturalAssetEntity child) -&gt; {</span>
<span class="fc" id="L181">				this.removeConnection(child, entity);</span>
<span class="fc" id="L182">				this.repository.save(child);</span>
<span class="fc" id="L183">			});</span>
		}

<span class="pc bpc" id="L186" title="5 of 6 branches missed.">		if (details.getAddress() != null || details.getLongitude() != null || details.getLatitude() != null) {</span>

<span class="pc bpc" id="L188" title="2 of 4 branches missed.">			if (entity.getLongitude() != null &amp;&amp; entity.getLatitude() != null) {</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">				if (entity.getAddress() == null) {</span>
<span class="nc" id="L190">					entity.setAddress(locationService</span>
<span class="nc" id="L191">							.coordinatesToAddress(new double[] { entity.getLongitude(), entity.getLatitude() }));</span>
				}
<span class="nc bnc" id="L193" title="All 2 branches missed.">			} else if (entity.getAddress() != null) {</span>
<span class="nc bnc" id="L194" title="All 4 branches missed.">				if (entity.getLongitude() == null &amp;&amp; entity.getLatitude() == null) {</span>
<span class="nc" id="L195">					double[] updatedCoordinates = locationService.addressToCoordinates(entity.getAddress());</span>
<span class="nc" id="L196">					entity.setLongitude(updatedCoordinates[0]);</span>
<span class="nc" id="L197">					entity.setLatitude(updatedCoordinates[1]);</span>
				}
			}

<span class="pc bpc" id="L201" title="2 of 4 branches missed.">			if (entity.getLongitude() != null &amp;&amp; entity.getLatitude() != null) {</span>
<span class="fc bfc" id="L202" title="All 2 branches covered.">				if (entity.getLocationId() != null) {</span>
<span class="fc" id="L203">					locationService.removePOI(entity.getLocationId());</span>
				}
<span class="fc" id="L205">				entity.setLocationId(locationService.addPOI(entity.getName(),</span>
<span class="fc" id="L206">						new double[] { entity.getLongitude(), entity.getLatitude() }));</span>
			}

		}

<span class="fc" id="L211">		final CulturalAssetEntity savedEntity = this.repository.save(entity);</span>
		
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">		if (entity.getCulturalAssetParent() != null) {</span>
<span class="fc" id="L214">			CulturalAssetEntity parent = this.findById(entity.getCulturalAssetParent().getId());</span>
<span class="fc" id="L215">			this.addConnection(savedEntity, parent);</span>
<span class="fc" id="L216">			this.repository.save(parent);</span>
		}

		// Warum gibt es hier ein oder?
<span class="pc bpc" id="L220" title="3 of 4 branches missed.">		if (entity.getCulturalAssetChildren() != null || !entity.getCulturalAssetChildren().isEmpty()) {</span>
<span class="fc" id="L221">			List&lt;CulturalAssetEntity&gt; children = entity.getCulturalAssetChildren().stream()</span>
<span class="fc" id="L222">					.map((CulturalAssetEntity child) -&gt; {</span>
<span class="fc" id="L223">						return this.findById(child.getId());					</span>
<span class="fc" id="L224">					}).collect(Collectors.toList());			</span>
<span class="fc" id="L225">			children.stream().forEach((CulturalAssetEntity child) -&gt; {				</span>
<span class="fc" id="L226">				this.addConnection(child, savedEntity);</span>
<span class="fc" id="L227">				this.repository.save(child);</span>
<span class="fc" id="L228">			});</span>
			
		}

<span class="fc" id="L232">		EventConsumer.sendEvent(&quot;CulturalAssetService.update&quot;, EventType.UPDATE.type, this.getIdentifier(),</span>
<span class="fc" id="L233">				EventConsumer.writeObjectAsJSON(savedEntity));</span>

<span class="fc" id="L235">		return savedEntity;</span>

	}

	/**
	 * Delete a cultural asset.
	 * 
	 * @param id - the cultural asset's identifier.
	 * @return The cultural asset that was deleted.
	 * @throws ResourceNotFoundException if there is no cultural asset with the
	 *                                   specified identifier.
	 */
	@Override
	public CulturalAssetEntity delete(long id) throws ResourceNotFoundException {

<span class="fc" id="L250">		Utility.LOG.trace(&quot;CulturalAssetService.delete called.&quot;);</span>

<span class="fc" id="L252">		CulturalAssetEntity entity = this.repository.findById(id)</span>
<span class="pc" id="L253">				.orElseThrow(() -&gt; new ResponseStatusException(HttpStatus.NOT_FOUND));</span>
<span class="fc" id="L254">		this.repository.delete(entity);</span>

<span class="fc bfc" id="L256" title="All 2 branches covered.">		if (entity.getLocationId() != null) {</span>
<span class="fc" id="L257">			locationService.removePOI(entity.getLocationId());</span>
		}

<span class="fc" id="L260">		EventConsumer.sendEvent(&quot;CulturalAssetService.delete&quot;, EventType.DELETE.type, this.getIdentifier(),</span>
<span class="fc" id="L261">				EventConsumer.writeObjectAsJSON(entity));</span>

<span class="fc" id="L263">		return entity;</span>

	}

	/**
	 * Get all cultural assets in a radius around a given middle point.
	 * 
	 * @param radius        - the radius of the search.
	 * @param longitude     - the longitude of the middle of the search.
	 * @param latitude      - the latitude of the middle of the search.
	 * @param specification - filter for the result.
	 * @param pageable      - sort and pagination for the result.
	 * @return The result as a page.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public Page&lt;CulturalAssetEntity&gt; findInRadius(double radius, double longitude, double latitude,
			EntitySpecification&lt;CulturalAssetEntity&gt; specification, Pageable pageable) {

<span class="fc" id="L281">		Utility.LOG.trace(&quot;CulturalAssetService.findInRadius called.&quot;);</span>

<span class="fc" id="L283">		List&lt;String&gt; entityIds = locationService.findInRadius(radius, new double[] { longitude, latitude });</span>
<span class="fc" id="L284">		List&lt;CulturalAssetEntity&gt; entities = entityIds.stream().map(this.repository::findByLocationId)</span>
<span class="fc" id="L285">				.collect(Collectors.toList());</span>

<span class="pc bpc" id="L287" title="1 of 2 branches missed.">		if (specification != null) {</span>
<span class="nc" id="L288">			CriteriaBuilder criteriaBuilder = em.getCriteriaBuilder();</span>
<span class="nc" id="L289">			CriteriaQuery&lt;CulturalAssetEntity&gt; criteriaQuery = criteriaBuilder.createQuery(CulturalAssetEntity.class);</span>
<span class="nc" id="L290">			Root&lt;CulturalAssetEntity&gt; root = criteriaQuery.from(CulturalAssetEntity.class);</span>

<span class="nc" id="L292">			entities = entities.stream().filter((Predicate&lt;? super CulturalAssetEntity&gt;) specification.toPredicate(root,</span>
<span class="nc" id="L293">					criteriaQuery, criteriaBuilder)).collect(Collectors.toList());</span>
		}

<span class="fc" id="L296">		Page&lt;CulturalAssetEntity&gt; page = new PageImpl&lt;CulturalAssetEntity&gt;(entities, pageable, entities.size());</span>

<span class="fc" id="L298">		EventConsumer.sendEvent(&quot;CulturalAssetService.findInRadius&quot;, EventType.READ.type, this.getIdentifier(),</span>
<span class="fc" id="L299">				EventConsumer.writeObjectAsJSON(page));</span>

<span class="fc" id="L301">		return page;</span>

	}

	/**
	 * Get all tasks of the cultural asset.
	 * 
	 * @param id            - the cultural asset's identifier.
	 * @param specification - filter for the result.
	 * @param pageable      - sort and pagination for the result.
	 * @return The result as a page.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public Page&lt;TaskEntity&gt; getAllTasks(long id, EntitySpecification&lt;TaskEntity&gt; specification, Pageable pageable) {

<span class="fc" id="L316">		Utility.LOG.trace(&quot;CulturalAssetService.getAllTasks called.&quot;);</span>

<span class="fc" id="L318">		CulturalAssetEntity entity = this.findById(id);</span>
<span class="fc" id="L319">		List&lt;TaskEntity&gt; tasks = entity.getTasks();</span>

<span class="pc bpc" id="L321" title="1 of 2 branches missed.">		if (specification != null) {</span>
<span class="nc" id="L322">			CriteriaBuilder criteriaBuilder = em.getCriteriaBuilder();</span>
<span class="nc" id="L323">			CriteriaQuery&lt;TaskEntity&gt; criteriaQuery = criteriaBuilder.createQuery(TaskEntity.class);</span>
<span class="nc" id="L324">			Root&lt;TaskEntity&gt; root = criteriaQuery.from(TaskEntity.class);</span>

<span class="nc" id="L326">			tasks = tasks.stream().filter(</span>
<span class="nc" id="L327">					(Predicate&lt;? super TaskEntity&gt;) specification.toPredicate(root, criteriaQuery, criteriaBuilder))</span>
<span class="nc" id="L328">					.collect(Collectors.toList());</span>
		}

<span class="fc" id="L331">		Page&lt;TaskEntity&gt; page = new PageImpl&lt;TaskEntity&gt;(tasks, pageable, tasks.size());</span>

<span class="fc" id="L333">		EventConsumer.sendEvent(&quot;CulturalAssetService.getAllTasks&quot;, EventType.READ.type, this.getIdentifier(),</span>
<span class="fc" id="L334">				EventConsumer.writeObjectAsJSON(page));</span>

<span class="fc" id="L336">		return page;</span>

	}
	
	/**
	 * Get all comments of the cultural asset.
	 * 
	 * @param id - the cultural asset's identifier.
	 * @param specification - filter for the result.
	 * @param pageable - sort and pagination for the result.
	 * @return The result as a page.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public Page&lt;CommentEntity&gt; getAllComments(long id, EntitySpecification&lt;CommentEntity&gt; specification,
			Pageable pageable) {

<span class="fc" id="L352">		CulturalAssetEntity entity = this.findById(id);</span>

<span class="fc" id="L354">		List&lt;CommentEntity&gt; comments = entity.getComments();</span>

<span class="pc bpc" id="L356" title="1 of 2 branches missed.">		if (specification != null) {</span>
<span class="nc" id="L357">			CriteriaBuilder criteriaBuilder = em.getCriteriaBuilder();</span>
<span class="nc" id="L358">			CriteriaQuery&lt;CommentEntity&gt; criteriaQuery = criteriaBuilder.createQuery(CommentEntity.class);</span>
<span class="nc" id="L359">			Root&lt;CommentEntity&gt; root = criteriaQuery.from(CommentEntity.class);		</span>
			
<span class="nc" id="L361">			comments = comments.stream().filter(</span>
<span class="nc" id="L362">					(Predicate&lt;? super CommentEntity&gt;) specification.toPredicate(root, criteriaQuery, criteriaBuilder))</span>
<span class="nc" id="L363">					.collect(Collectors.toList());</span>
		}

<span class="fc" id="L366">		Page&lt;CommentEntity&gt; page = new PageImpl&lt;CommentEntity&gt;(comments, pageable, comments.size());</span>
		
<span class="fc" id="L368">		EventConsumer.sendEvent(&quot;CulturalAssetService.getAllComments&quot;, EventType.READ.type, this.getIdentifier(), EventConsumer.writeObjectAsJSON(page));</span>

<span class="fc" id="L370">		return page;</span>
		
	}

	/**
	 * Get all children of the cultural asset.
	 * 
	 * @param id            - the cultural asset's identifier.
	 * @param specification - filter for the result.
	 * @param pageable      - sort and pagination for the result.
	 * @return The result as a page.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public Page&lt;CulturalAssetEntity&gt; getAllChildren(long id, EntitySpecification&lt;CulturalAssetEntity&gt; specification,
			Pageable pageable) {

<span class="fc" id="L386">		Utility.LOG.trace(&quot;CulturalAssetService.getAllChildren called.&quot;);</span>

<span class="fc" id="L388">		CulturalAssetEntity entity = this.findById(id);</span>
<span class="fc" id="L389">		List&lt;CulturalAssetEntity&gt; children = entity.getCulturalAssetChildren();</span>

<span class="pc bpc" id="L391" title="1 of 2 branches missed.">		if (specification != null) {</span>
<span class="nc" id="L392">			CriteriaBuilder criteriaBuilder = em.getCriteriaBuilder();</span>
<span class="nc" id="L393">			CriteriaQuery&lt;CulturalAssetEntity&gt; criteriaQuery = criteriaBuilder.createQuery(CulturalAssetEntity.class);</span>
<span class="nc" id="L394">			Root&lt;CulturalAssetEntity&gt; root = criteriaQuery.from(CulturalAssetEntity.class);</span>

<span class="nc" id="L396">			children = children.stream().filter((Predicate&lt;? super CulturalAssetEntity&gt;) specification.toPredicate(root,</span>
<span class="nc" id="L397">					criteriaQuery, criteriaBuilder)).collect(Collectors.toList());</span>
		}

<span class="fc" id="L400">		Page&lt;CulturalAssetEntity&gt; page = new PageImpl&lt;CulturalAssetEntity&gt;(children, pageable, children.size());</span>

<span class="fc" id="L402">		EventConsumer.sendEvent(&quot;CulturalAssetService.getAllChildren&quot;, EventType.READ.type, this.getIdentifier(),</span>
<span class="fc" id="L403">				EventConsumer.writeObjectAsJSON(page));</span>

<span class="fc" id="L405">		return page;</span>

	}

	/**
	 * Get all children of the cultural asset.
	 * 
	 * @param id            - the cultural asset's identifier.
	 * @param specification - filter for the result.
	 * @param pageable      - sort and pagination for the result.
	 * @return The result as a page.
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public Page&lt;NotificationEntity&gt; getAllNotifications(long id, EntitySpecification&lt;NotificationEntity&gt; specification,
			Pageable pageable) {

<span class="fc" id="L421">		Utility.LOG.trace(&quot;CulturalAssetService.getAllNotifications called.&quot;);</span>

<span class="fc" id="L423">		CulturalAssetEntity entity = this.findById(id);</span>
<span class="fc" id="L424">		List&lt;NotificationEntity&gt; notifications = entity.getNotifications();</span>

<span class="pc bpc" id="L426" title="1 of 2 branches missed.">		if (specification != null) {</span>
<span class="nc" id="L427">			CriteriaBuilder criteriaBuilder = em.getCriteriaBuilder();</span>
<span class="nc" id="L428">			CriteriaQuery&lt;NotificationEntity&gt; criteriaQuery = criteriaBuilder.createQuery(NotificationEntity.class);</span>
<span class="nc" id="L429">			Root&lt;NotificationEntity&gt; root = criteriaQuery.from(NotificationEntity.class);</span>

<span class="nc" id="L431">			notifications = notifications.stream().filter((Predicate&lt;? super NotificationEntity&gt;) specification</span>
<span class="nc" id="L432">					.toPredicate(root, criteriaQuery, criteriaBuilder)).collect(Collectors.toList());</span>
		}

<span class="fc" id="L435">		Page&lt;NotificationEntity&gt; page = new PageImpl&lt;NotificationEntity&gt;(notifications, pageable, notifications.size());</span>

<span class="fc" id="L437">		EventConsumer.sendEvent(&quot;CulturalAssetService.getAllNotifications&quot;, EventType.READ.type, this.getIdentifier(),</span>
<span class="fc" id="L438">				EventConsumer.writeObjectAsJSON(page));</span>

<span class="fc" id="L440">		return page;</span>

	}

	/**
	 * Get the distance between a point and the cultural asset.
	 * 
	 * @param id        - the cultural asset's identifier.
	 * @param longitude - the longitude of the point.
	 * @param latitude  - the latitude of the point.
	 * @return The result as a double.
	 */
	public double getDistance(long id, double longitude, double latitude) {

<span class="fc" id="L454">		Utility.LOG.trace(&quot;CulturalAssetService.getDistance called.&quot;);</span>

<span class="fc" id="L456">		CulturalAssetEntity entity = this.findById(id);</span>

<span class="fc" id="L458">		double[] entityLocation = new double[] { entity.getLongitude(), entity.getLatitude() };</span>

<span class="fc" id="L460">		double distance = locationService.calculateDistance(entityLocation, new double[] { longitude, latitude });</span>

<span class="fc" id="L462">		EventConsumer.sendEvent(&quot;CulturalAssetService.getDistance&quot;, EventType.READ.type, this.getIdentifier(),</span>
<span class="fc" id="L463">				EventConsumer.writeObjectAsJSON(distance));</span>

<span class="fc" id="L465">		return distance;</span>

	}

	/**
	 * Adds a child to the cultural asset.
	 * 
	 * @param id      - the cultural asset's identifier.
	 * @param childId - the child's identifier.
	 * @return The cultural asset after the child was added.
	 */
	public CulturalAssetEntity addCulturalAssetChild(long id, long childId) {

<span class="fc" id="L478">		Utility.LOG.trace(&quot;CulturalAssetService.addCulturalAssetChild called.&quot;);</span>

<span class="fc" id="L480">		CulturalAssetEntity parent = this.findById(id);</span>
<span class="fc" id="L481">		CulturalAssetEntity child = this.findById(childId);</span>
<span class="fc" id="L482">		CulturalAssetEntity updatedEntity = parent;</span>

<span class="fc" id="L484">		this.addConnection(child, parent);</span>

<span class="pc bpc" id="L486" title="2 of 4 branches missed.">		if (this.testLoopError(child) || this.testHeightError(child)) {</span>

<span class="nc" id="L488">			this.removeConnection(child, parent);</span>

<span class="nc" id="L490">		} else {</span>

<span class="fc" id="L492">			updatedEntity = this.repository.save(parent);</span>
<span class="fc" id="L493">			this.repository.save(child);</span>

		}

<span class="fc" id="L497">		EventConsumer.sendEvent(&quot;CulturalAssetService.addCulturalAssetChild&quot;, EventType.UPDATE.type,</span>
<span class="fc" id="L498">				this.getIdentifier(), EventConsumer.writeObjectAsJSON(updatedEntity));</span>

<span class="fc" id="L500">		return updatedEntity;</span>

	}

	/**
	 * Removes a child to the cultural asset.
	 * 
	 * @param id      - the cultural asset's identifier.
	 * @param childId - the child's identifier.
	 * @return The cultural asset after the child was removed.
	 */
	public CulturalAssetEntity removeCulturalAssetChild(long id, long childId) {

<span class="fc" id="L513">		Utility.LOG.trace(&quot;CulturalAssetService.removeCulturalAssetChild called.&quot;);</span>

<span class="fc" id="L515">		CulturalAssetEntity parent = this.findById(id);</span>
<span class="fc" id="L516">		CulturalAssetEntity child = this.findById(childId);</span>

<span class="fc" id="L518">		this.removeConnection(child, parent);</span>

<span class="fc" id="L520">		final CulturalAssetEntity updatedEntity = this.repository.save(parent);</span>

<span class="fc" id="L522">		this.repository.save(child);</span>

<span class="fc" id="L524">		EventConsumer.sendEvent(&quot;CulturalAssetService.removeCulturalAssetChild&quot;, EventType.UPDATE.type,</span>
<span class="fc" id="L525">				this.getIdentifier(), EventConsumer.writeObjectAsJSON(updatedEntity));</span>

<span class="fc" id="L527">		return updatedEntity;</span>

	}

	/**
	 * Sets the parent of the cultural asset.
	 * 
	 * @param id       - the cultural asset's identifier.
	 * @param parentId - the parent's identifier.
	 * @return The cultural asset after the parent was set.
	 */
	public CulturalAssetEntity setCulturalAssetParent(long id, long parentId) {

<span class="fc" id="L540">		Utility.LOG.trace(&quot;CulturalAssetService.setCulturalAssetParent called.&quot;);</span>

<span class="fc" id="L542">		CulturalAssetEntity child = this.findById(id);</span>
<span class="fc" id="L543">		CulturalAssetEntity parent = this.findById(parentId);</span>
<span class="fc" id="L544">		CulturalAssetEntity updatedEntity = child;</span>

<span class="fc" id="L546">		this.addConnection(child, parent);</span>

<span class="pc bpc" id="L548" title="2 of 4 branches missed.">		if (this.testLoopError(child) || this.testHeightError(child)) {</span>

<span class="nc" id="L550">			this.removeConnection(child, parent);</span>

<span class="nc" id="L552">		} else {</span>

<span class="fc" id="L554">			updatedEntity = this.repository.save(child);</span>
<span class="fc" id="L555">			this.repository.save(parent);</span>

		}

<span class="fc" id="L559">		EventConsumer.sendEvent(&quot;CulturalAssetService.setCulturalAssetParent&quot;, EventType.UPDATE.type,</span>
<span class="fc" id="L560">				this.getIdentifier(), EventConsumer.writeObjectAsJSON(updatedEntity));</span>

<span class="fc" id="L562">		return updatedEntity;</span>

	}

	/**
	 * Removes the parent of the cultural asset.
	 * 
	 * @param id - the cultural asset's identifier.
	 * @return The cultural asset after the parent was removed.
	 */
	public CulturalAssetEntity removeCulturalAssetParent(long id) {

<span class="fc" id="L574">		Utility.LOG.trace(&quot;CulturalAssetService.removeCulturalAssetParent called.&quot;);</span>

<span class="fc" id="L576">		CulturalAssetEntity child = this.findById(id);</span>
<span class="fc" id="L577">		CulturalAssetEntity parent = child.getCulturalAssetParent();</span>

<span class="fc" id="L579">		this.removeConnection(child, parent);</span>

<span class="fc" id="L581">		final CulturalAssetEntity updatedEntity = this.repository.save(child);</span>

<span class="fc" id="L583">		this.repository.save(parent);</span>

<span class="fc" id="L585">		EventConsumer.sendEvent(&quot;CulturalAssetService.removeCulturalAssetParent&quot;, EventType.UPDATE.type,</span>
<span class="fc" id="L586">				this.getIdentifier(), EventConsumer.writeObjectAsJSON(updatedEntity));</span>

<span class="fc" id="L588">		return updatedEntity;</span>

	}

	/**
	 * Adds a connection between a parent and a child in the hierarchy of cultural
	 * assets.
	 * 
	 * @param child  - the child.
	 * @param parent - the parent.
	 */
	private void addConnection(CulturalAssetEntity child, CulturalAssetEntity parent) {

<span class="fc" id="L601">		Utility.LOG.trace(&quot;CulturalAssetService.addConnection called.&quot;);</span>

<span class="fc" id="L603">		List&lt;CulturalAssetEntity&gt; newChildren = parent.getCulturalAssetChildren();</span>

		// if the new child is already a child
<span class="fc bfc" id="L606" title="All 2 branches covered.">		if (!newChildren.contains(child)) {</span>
<span class="fc" id="L607">			newChildren.add(child);</span>
<span class="fc" id="L608">			parent.setCulturalAssetChildren(newChildren);</span>
<span class="fc" id="L609">			child.setCulturalAssetParent(parent);</span>
<span class="fc" id="L610">			this.updateLevels(child, parent.getLevel() + 1);</span>
		}

<span class="fc" id="L613">	}</span>

	/**
	 * Removes a connection between a parent and a child in the hierarchy of
	 * cultural assets.
	 * 
	 * @param child  - the child.
	 * @param parent - the parent.
	 */
	private void removeConnection(CulturalAssetEntity child, CulturalAssetEntity parent) {

<span class="fc" id="L624">		Utility.LOG.trace(&quot;CulturalAssetService.removeConnection called.&quot;);</span>

<span class="fc" id="L626">		List&lt;CulturalAssetEntity&gt; newChildren = parent.getCulturalAssetChildren();</span>

		// if the child is actually a child
<span class="fc bfc" id="L629" title="All 2 branches covered.">		if (newChildren.contains(child)) {</span>
<span class="fc" id="L630">			newChildren.remove(child);</span>
<span class="fc" id="L631">			parent.setCulturalAssetChildren(newChildren);</span>
<span class="fc" id="L632">			child.setCulturalAssetParent(null);</span>
<span class="fc" id="L633">			this.updateLevels(child, 0);</span>
		}

<span class="fc" id="L636">	}</span>

	/**
	 * Checks if a cultural asset is part of a loop in the hierarchy of cultural
	 * assets.
	 * 
	 * @param entity - the cultural asset.
	 * @return If there is an error, true if yes and false if no.
	 */
	private boolean testLoopError(CulturalAssetEntity entity) {

<span class="fc" id="L647">		CulturalAssetEntity parent = entity.getCulturalAssetParent();</span>

<span class="pc bpc" id="L649" title="1 of 2 branches missed.">		for (int i = 0; i &lt; 4; i++) {</span>

<span class="fc bfc" id="L651" title="All 2 branches covered.">			if (parent == null) {</span>
<span class="fc" id="L652">				return false;</span>
			} else {
<span class="fc" id="L654">				parent = parent.getCulturalAssetParent();</span>
			}

		}

<span class="nc" id="L659">		return true;</span>

	}

	/**
	 * Checks if a cultural asset violates the max height of the hierarchy of
	 * cultural assets.
	 * 
	 * @param entity - the cultural asset.
	 * @return If there is an error, true if yes and false if no.
	 */
	private boolean testHeightError(CulturalAssetEntity entity) {

<span class="pc bpc" id="L672" title="1 of 2 branches missed.">		if (entity.getLevel() &gt;= 4) {</span>

<span class="nc" id="L674">			return true;</span>

		} else {

<span class="fc" id="L678">			List&lt;CulturalAssetEntity&gt; children = entity.getCulturalAssetChildren();</span>

<span class="pc bpc" id="L680" title="1 of 2 branches missed.">			if (!children.isEmpty()) {</span>
<span class="nc" id="L681">				children.stream().forEach((CulturalAssetEntity nextEntity) -&gt; {</span>
<span class="nc" id="L682">					this.testHeightError(nextEntity);</span>
<span class="nc" id="L683">				});</span>

			}

		}

<span class="fc" id="L689">		return false;</span>

	}

	/**
	 * Updates the level of the cultural asset. This also updates all children below
	 * the cultural asset in the hierarchy of cultural assets.
	 * 
	 * @param entity - the cultural asset.
	 * @param level  - the new level of the cultural asset.
	 */
	private void updateLevels(CulturalAssetEntity entity, int level) {

<span class="fc" id="L702">		entity.setLevel(level);</span>
<span class="fc" id="L703">		this.repository.save(entity);</span>
<span class="fc" id="L704">		List&lt;CulturalAssetEntity&gt; children = entity.getCulturalAssetChildren();</span>

<span class="fc bfc" id="L706" title="All 2 branches covered.">		if (!children.isEmpty()) {</span>
<span class="fc" id="L707">			children.stream().forEach((CulturalAssetEntity nextEntity) -&gt; {</span>
<span class="fc" id="L708">				this.updateLevels(nextEntity, level + 1);</span>
<span class="fc" id="L709">			});</span>

		}

<span class="fc" id="L713">	}</span>

	/**
	 * Updates the endangered state of the cultural asset. This also updates the
	 * endangered state of all children below the cultural asset in the hierarchy of
	 * cultural assets. This also updates the endangered state of all connected
	 * tasks.
	 * 
	 * @param entity - the cultural asset.
	 * @param state  - the new endangered state of the cultural asset.
	 */
	public void updateIsEndangered(CulturalAssetEntity entity, int state) {

<span class="nc" id="L726">		entity.setIsEndangered(state);</span>
<span class="nc" id="L727">		this.repository.save(entity);</span>
<span class="nc" id="L728">		List&lt;CulturalAssetEntity&gt; children = entity.getCulturalAssetChildren();</span>
<span class="nc" id="L729">		List&lt;TaskEntity&gt; tasks = entity.getTasks();</span>

<span class="nc bnc" id="L731" title="All 2 branches missed.">		if (!tasks.isEmpty()) {</span>
<span class="nc" id="L732">			tasks.stream().forEach((TaskEntity task) -&gt; {</span>
<span class="nc" id="L733">				task.setIsEndangered(state);</span>
<span class="nc" id="L734">				taskRepository.save(task);</span>
<span class="nc" id="L735">			});</span>

		}

<span class="nc bnc" id="L739" title="All 2 branches missed.">		if (!children.isEmpty()) {</span>
<span class="nc" id="L740">			children.stream().forEach((CulturalAssetEntity nextEntity) -&gt; {</span>
<span class="nc" id="L741">				this.updateIsEndangered(nextEntity, state);</span>
<span class="nc" id="L742">			});</span>

		}

<span class="nc" id="L746">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202103210711</span></div></body></html>